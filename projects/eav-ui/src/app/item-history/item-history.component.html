<ng-container *ngIf="viewModel$ | async as vm">
  <div class="eav-dialog eav-no-scrollbar">
    <div class="eav-dialog-header">
      <div class="eav-dialog-header__title">Item History</div>
      <button mat-icon-button tippy="Close dialog" (click)="closeDialog()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="eav-dialog-content">
      <p>Check version history for this item and restore the version you need.</p>
    
      <div *ngIf="vm.historyItems?.length > 0" class="eav-compare-box">
        <mat-form-field color="accent" class="eav-form-field eav-compare-box__dropdown">
          <mat-select [value]="vm.compareWith" name="Scope" (selectionChange)="compareChange($event.value)">
            <mat-option value="previous">Compare with: Previous</mat-option>
            <mat-option value="live">Compare with: Live</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    
      <div>
        <div *ngIf="vm.historyItems === null">Loading...</div>
        <div *ngIf="vm.historyItems?.length === 0">No previous versions of this item found</div>
    
        <mat-accordion multi *ngIf="vm.historyItems?.length > 0" class="eav-history-tables">
          <mat-expansion-panel *ngFor="let historyItem of vm.historyItems"
            [expanded]="expandedPanels[historyItem.versionNumber]"
            (expandedChange)="panelExpandedChange($event, historyItem.versionNumber)">
            <mat-expansion-panel-header>
              <mat-panel-title>Version {{ historyItem.versionNumber }}</mat-panel-title>
              <mat-panel-description>{{ historyItem.timeStamp | date:'yyyy-MM-dd hh:mm' }}</mat-panel-description>
            </mat-expansion-panel-header>
    
            <ng-container *ngIf="expandedPanels[historyItem.versionNumber]">
              <div class="eav-table-row" *ngFor="let attribute of historyItem.attributes">
                <div class="eav-table-row__main eav-row-main"
                  (click)="attributeExpandedToggle(historyItem.versionNumber, attribute.name)">
                  <div class="eav-row-main__label eav-history-{{ attribute.change }}">
                    {{ attribute.name }}
                  </div>
                  <div class="eav-row-main__value eav-history-{{ attribute.change }}">
                    <ng-container *ngIf="!expandedAttributes[historyItem.versionNumber + attribute.name]">
                      {{ attribute.values[0]?.value }}
                    </ng-container>
                  </div>
                  <div class="eav-row-main__type">
                    <i>[{{ attribute.dataType }}]</i>
                  </div>
                </div>
    
                <div class="eav-table-row__details" *ngIf="expandedAttributes[historyItem.versionNumber + attribute.name]">
                  <div class="eav-detail-row" *ngFor="let value of attribute.values">
                    <div class="eav-detail-row__label eav-history-{{ value.change }}">{{ value.langKey }}:</div>
                    <div class="eav-detail-row__value">
                      <div class="eav-history-{{ value.change }}" *ngIf="value.change !== 'changed'">
                        {{ value.change === 'deleted' ? value.oldValue : value.value }}
                      </div>
                      <ng-container *ngIf="value.change === 'changed'">
                        <div class="eav-history-new">{{ value.value }}</div>
                        <div class="eav-history-deleted eav-history-deleted__value">{{ value.oldValue }}</div>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div>
    
              <div class="eav-row-actions">
                <button mat-raised-button color="accent" *ngIf="!historyItem.isLastVersion"
                  (click)="restore(historyItem.changeSetId)">
                  Restore
                </button>
              </div>
            </ng-container>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    
      <mat-paginator color="accent" showFirstLastButtons="true" [length]="vm.length" [pageSize]="vm.pageSize"
        [pageSizeOptions]="pageSizeOptions" (page)="pageChange($event)" *ngIf="vm.historyItems?.length > 0">
      </mat-paginator>
    </div>
  </div>
</ng-container>