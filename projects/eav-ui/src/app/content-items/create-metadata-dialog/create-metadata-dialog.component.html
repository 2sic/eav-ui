<ng-container *ngIf="viewModel$ | async as vm">
  <div class="eav-dialog">
    <div class="eav-dialog-header">
      <div class="eav-dialog-header__title">Create Metadata</div>
    </div>
    <div class="eav-dialog-content">
      <p>
        This is a special operation to add an item which is metadata for another item,
        see <a href="https://go.2sxc.org/metadata" target="_blank">docs</a>.
      </p>
      <form [formGroup]="form">
        <!-- Target Type -->
        <mat-form-field color="accent" class="eav-form-field">
          <mat-label>Target</mat-label>
    
          <mat-select *ngIf="vm.guidedMode" formControlName="targetType" required>
            <mat-option *ngFor="let option of targetTypeOptions" [value]="option.targetType">
              {{ option.label }}
            </mat-option>
            <mat-option *ngIf="vm.unknownTargetType" [value]="vm.formValues.targetType">
              {{ vm.formValues.targetType }}
            </mat-option>
          </mat-select>
    
          <input matInput type="number" min="0" *ngIf="!vm.guidedMode" formControlName="targetType" required>
        </mat-form-field>
    
        <app-field-hint
          *ngIf="form.controls['targetType'].touched && !form.controls['targetType'].invalid && vm.unknownTargetType"
          [isError]="false">
          Warning: you entered an unknown target type. This may work or may not. Please be sure you know what you're doing
        </app-field-hint>
        <app-field-hint *ngIf="vm.targetTypeHint" [isError]="false">{{ vm.targetTypeHint }}</app-field-hint>
        <app-field-hint *ngIf="form.controls['targetType'].touched && form.controls['targetType'].errors?.required"
          [isError]="true">
          This field is required
        </app-field-hint>
        <app-field-hint *ngIf="form.controls['targetType'].touched && form.controls['targetType'].errors?.pattern"
          [isError]="true">
          Must be a whole number
        </app-field-hint>
    
        <!-- Key Type -->
        <mat-form-field color="accent" class="eav-form-field">
          <mat-label>Key type</mat-label>
    
          <mat-select formControlName="keyType" required>
            <mat-option *ngFor="let option of vm.keyTypeOptions" [value]="option">
              {{ option }}
            </mat-option>
          </mat-select>
        </mat-form-field>
    
        <app-field-hint *ngIf="form.controls['keyType'].touched && form.controls['keyType'].errors?.required"
          [isError]="true">
          This field is required
        </app-field-hint>
    
        <!-- Content Type for Content Items -->
        <mat-form-field color="accent" class="eav-form-field"
          *ngIf="vm.guidedMode && vm.formValues.targetType === eavConstants.metadata.entity.targetType">
          <mat-label>Content Type</mat-label>
    
          <mat-select formControlName="contentTypeForContentItems"
            [placeholder]="!vm.contentTypes.length ? 'No items found' : ''">
            <mat-option *ngFor="let contentType of vm.contentTypes" [value]="contentType.StaticName">
              {{ contentType.Label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
    
        <!-- Scope for Content Types -->
        <mat-form-field color="accent" class="eav-form-field"
          *ngIf="vm.guidedMode && (vm.formValues.targetType === eavConstants.metadata.entity.targetType || vm.formValues.targetType === eavConstants.metadata.contentType.targetType)">
          <mat-label>Scope</mat-label>
    
          <mat-select formControlName="scopeForContentTypes"
            [placeholder]="!vm.scopeOptions.length ? 'No items found' : ''">
            <mat-option *ngFor="let scopeOption of vm.scopeOptions" [value]="scopeOption.value">
              {{ scopeOption.name }}
            </mat-option>
            <mat-option [value]="dropdownInsertValue">Other...</mat-option>
          </mat-select>
        </mat-form-field>
    
        <app-field-hint>
          The scope should almost never be changed -
          <a href="https://2sxc.org/help?tag=scope" target="_blank" appClickStopPropagation>see help</a>
        </app-field-hint>
    
        <!-- Key -->
        <mat-form-field color="accent" class="eav-form-field">
          <mat-label>Key</mat-label>
    
          <ng-container *ngIf="vm.guidedMode; then specialKeyInputs else defaultKeyInput">
          </ng-container>
    
          <ng-template #specialKeyInputs>
            <ng-container [ngSwitch]="vm.formValues.targetType">
              <ng-container *ngSwitchCase="eavConstants.metadata.entity.targetType">
                <mat-select *ngIf="vm.guidedKey" formControlName="key" required
                  [placeholder]="!vm.contentItems.length ? 'No items found' : ''">
                  <mat-option *ngFor="let item of vm.contentItems" [value]="item.Guid">
                    {{ item.Title }} ({{ item.Id }})
                  </mat-option>
                </mat-select>
    
                <input matInput type="text" *ngIf="!vm.guidedKey" formControlName="key" required>
              </ng-container>
    
              <ng-container *ngSwitchCase="eavConstants.metadata.contentType.targetType">
                <mat-select *ngIf="vm.guidedKey" formControlName="key" required
                  [placeholder]="!vm.contentTypes.length ? 'No items found' : ''">
                  <mat-option *ngFor="let contentType of vm.contentTypes" [value]="contentType.StaticName">
                    {{ contentType.Label }}
                  </mat-option>
                </mat-select>
    
                <input matInput type="text" *ngIf="!vm.guidedKey" formControlName="key" required>
              </ng-container>
    
              <ng-container *ngSwitchDefault>
                <ng-container *ngTemplateOutlet="defaultKeyInput"></ng-container>
              </ng-container>
            </ng-container>
          </ng-template>
    
          <ng-template #defaultKeyInput>
            <input matInput type="text" *ngIf="vm.formValues.keyType !== eavConstants.keyTypes.number" formControlName="key"
              required>
            <input matInput type="number" *ngIf="vm.formValues.keyType === eavConstants.keyTypes.number"
              formControlName="key" required>
          </ng-template>
    
          <div matTextSuffix class="selection-suffix" *ngIf="vm.guidedMode && vm.guidedKeyExists">
            <button mat-icon-button type="button" [ngClass]="{ 'active': vm.guidedKey }" tippy="Pick existing value"
              (click)="toggleGuidedKey(true)">
              <mat-icon>search</mat-icon>
            </button>
            <button mat-icon-button type="button" [ngClass]="{ 'active': !vm.guidedKey }" tippy="Manual entry"
              (click)="toggleGuidedKey(false)">
              <mat-icon>text_fields</mat-icon>
            </button>
          </div>
        </mat-form-field>
    
        <app-field-hint *ngIf="form.controls['key'].touched && form.controls['key'].errors?.required" [isError]="true">
          This field is required
        </app-field-hint>
        <app-field-hint *ngIf="form.controls['key'].touched && form.controls['key'].errors?.patternWholeNumber"
          [isError]="true">
          Must be a whole number
        </app-field-hint>
        <app-field-hint *ngIf="form.controls['key'].touched && form.controls['key'].errors?.patternGuid" [isError]="true">
          Must be a valid GUID
        </app-field-hint>
      </form>
    </div>
    <mat-dialog-actions class="eav-dialog-actions">
      <mat-slide-toggle color="accent"
        [tippy]="vm.guidedMode ? 'Guided mode helps you select options that work' : 'Manual mode is for advanced uses and allows you to insert any values'"
        [checked]="vm.guidedMode" (change)="toggleGuidedMode($event)">
        {{ vm.guidedMode ? 'Guided' : 'Manual' }}
      </mat-slide-toggle>
      <div>
        <button mat-raised-button type="button" (click)="closeDialog()">Cancel</button>
        <button mat-raised-button type="button" color="accent" [disabled]="!form.valid" (click)="confirm()">
          Confirm
        </button>
      </div>
    </mat-dialog-actions>
  </div>
</ng-container>