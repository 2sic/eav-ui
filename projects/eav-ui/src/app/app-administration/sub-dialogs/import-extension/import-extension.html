<div class="eav-dialog">
  <div class="eav-dialog-header">
    <div class="eav-dialog-header__title">{{ dialogData.title }}</div>
    <button mat-icon-button tippy="Close dialog" (click)="closeDialog()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <div class="eav-dialog-content">
    @if (!file()) {
      <div
        class="file-drop-zone"
        appDragAndDrop
        (filesDropped)="filesDropped($event)"
      >
        <p>{{ dialogData.description }}</p>
        <p>Drag and drop files here or click to select</p>
        <input
          type="file"
          [accept]="dialogData.allowedFileTypes"
          [multiple]="dialogData.multiple"
          (change)="filesChanged($event)"
          style="display: none"
          #fileInput
        />
        <button
          mat-raised-button
          color="primary"
          (click)="fileInput.click()"
        >
          Select Files
        </button>
        @if (!file()) {
          <button
            mat-raised-button
            class="eav-app-catalog-button eav-action-button"
            [disabled]="canSave()"
            tippy="Open extension catalog"
            (click)="toggleShowExtensionCatalog()"
          >
            Extensions Catalog
          </button>
        }
      </div>
    }

    @if (isLoadingPreflight()) {
      <div class="preflight-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Running preflight check...</p>
      </div>
    }

    @if (preflightError()) {
      <div class="preflight-error">
        <h3>Error</h3>
        <p>{{ preflightError() }}</p>
      </div>
    }

    @if (extension() && !isLoadingPreflight()) {
      <em>File: {{ file().name }}</em>

      <h4>{{ extension().name }} Details</h4>
      <span>Version {{ extension().version }}</span>

      <br />

      <div class="ext-info">
        <div class="info-row">
          <span class="label">File Count:</span>
          <span class="value">
            {{ extension().fileCount }}
          </span>
        </div>
        <div class="info-row">
          <span class="label">Supports Editions:</span>
          <span class="value">
            {{ extension().editionsSupported ? 'Yes' : 'No' }}
          </span>
        </div>
      </div>

      <div class="ext-features">
        <h4>Features</h4>
        <mat-chip-set>
          @for (
            feature of extension().features | keyvalue;
            track feature.key
          ) {
            <mat-chip [class.disabled]="!feature.value">
              {{ feature.key.split('Inside').join('') }}
            </mat-chip>
          }
        </mat-chip-set>
      </div>

      @if (extension().editionsSupported && editions()?.length) {
        <div class="ext-editions">
          <h4>Editions</h4>
          <div class="edition-selector">
            <mat-form-field color="accent" class="eav-mat-form-field">
              <mat-label>Select Editions to Install</mat-label>
              <mat-select [(value)]="selectedEditions" multiple>
                @for (edition of editions(); track edition.edition) {
                  <mat-option [value]="edition.edition">
                    {{ edition.edition || 'Default' }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      }
    }

    @if (remotePreflight()) {
      <div class="remote-preflight-details">
        <h4>{{ remotePreflight().name }} Details</h4>
        <span>Version {{ remotePreflight().version }}</span>
        <br />
        <div class="ext-info">
          <div class="info-row">
            <span class="label">File Count:</span>
            <span class="value">{{ remotePreflight().fileCount }}</span>
          </div>
          <div class="info-row">
            <span class="label">Supports Editions:</span>
            <span class="value">{{ remotePreflight().editionsSupported ? 'Yes' : 'No' }}</span>
          </div>
        </div>
        <div class="ext-features">
          <h4>Features</h4>
          <mat-chip-set>
            @for (feature of remotePreflight().features | keyvalue; track feature.key) {
              <mat-chip [class.disabled]="!feature.value">
                {{ feature.key.split('Inside').join('') }}
              </mat-chip>
            }
          </mat-chip-set>
        </div>
        @if (remotePreflight().editionsSupported && remotePreflight().editions?.length) {
          <div class="ext-editions">
            <h4>Editions</h4>
            <div class="edition-selector">
              <mat-form-field color="accent" class="eav-mat-form-field">
                <mat-label>Select Editions to Install</mat-label>
                <mat-select [(value)]="remoteSelectedEditions" multiple>
                  @for (edition of remotePreflight().editions; track edition.edition) {
                    <mat-option [value]="edition.edition">
                      {{ edition.edition || 'Default' }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        }
        <button
          mat-raised-button
          color="primary"
          class="eav-action-button"
          (click)="installRemote()"
          [disabled]="!canInstallRemote()"
        >
          Install
        </button>
      </div>
    }

    @if (!file() && showExtensionCatalog()) {
      @if (ready) {
        <iframe
          #installerWindow
          class="eav-app-catalog-iframe"
          [src]="remoteInstallerUrl"
        ></iframe>
      }
      @if (installingRemote()) {
        <div class="eav-progress">
          <mat-progress-spinner [mode]="'indeterminate'"
          ></mat-progress-spinner>
          <span>
            Installing..
          </span>
        </div>
      }
    }

    @if (isInstalling()) {
      <div class="installing">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Installing extension...</p>
      </div>
    }
  </div>

  <mat-dialog-actions align="end">
    @if (file() && !preflightError()) {
      <button
        mat-raised-button
        class="eav-action-button"
        (click)="install()"
        [disabled]="!canSave()"
      >
        Install
      </button>
    }
  </mat-dialog-actions>
</div>
