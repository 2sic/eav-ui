<div class="eav-dialog">
  <div class="eav-dialog-header">
    <div class="eav-dialog-header__title">{{ dialogData.title }}</div>
    <button mat-icon-button tippy="Close dialog" (click)="closeDialog()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <div class="eav-dialog-content">
    @if (!extension() && !isLoadingPreflight()) {
      <!-- Initial State: Dropzone and Catalog Entry -->
      <div
        class="file-drop-zone"
        appDragAndDrop
        (filesDropped)="filesDropped($event)"
      >
        @if (!showExtensionCatalog()) {
          <p>{{ dialogData.description }}</p>
          <p>Drag and drop files here or click to select</p>
          <input
            type="file"
            [accept]="dialogData.allowedFileTypes"
            [multiple]="dialogData.multiple"
            (change)="filesChanged($event)"
            style="display: none"
            #fileInput
          />
          <button
            mat-raised-button
            color="primary"
            (click)="fileInput.click()"
          >
            Select Files
          </button>
          
          <button
            mat-raised-button
            class="eav-app-catalog-button eav-action-button"
            tippy="Open extension catalog"
            (click)="toggleShowExtensionCatalog()"
          >
            Extensions Catalog
          </button>
        }

        <!-- Catalog Iframe -->
        @if (showExtensionCatalog()) {
          @if (ready) {
            <iframe
              #installerWindow
              class="eav-app-catalog-iframe"
              [src]="remoteInstallerUrl"
            ></iframe>
          }
        }
      </div>
    }

    <!-- Loading State -->
    @if (isLoadingPreflight()) {
      <div class="preflight-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Running preflight check...</p>
      </div>
    }

    <!-- Error State -->
    @if (preflightError()) {
      <div class="preflight-error">
        <h3>Error</h3>
        <p>{{ preflightError() }}</p>
        <button
          mat-stroked-button
          (click)="cancelPreflight()"
          >
            Back
          </button>
      </div>
    }

    @if (extension() && !isLoadingPreflight()) {
      <mat-accordion>
        <mat-expansion-panel [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>Extension Details</mat-panel-title>
          </mat-expansion-panel-header>
            <div class="unified-preflight-details">
              
              <!-- Source Indicator -->
              @if (isFileSource) {
                File:
                <em>{{ currentFile?.name }}</em>
              } @else {
                Remote Source:
                <em>
                  <a [href]="preflightSource">
                    {{ preflightSource.toString().substring(0, 50) }}...
                  </a>
                </em>
              }

              <h4>{{ extension().name }} Details</h4>
              <span>Version {{ extension().version }}</span>

              <br />

              <div class="ext-info">
                <div class="info-row">
                  <span class="label">File Count:</span>
                  <span class="value">
                    {{ extension().fileCount }}
                  </span>
                </div>
                <div class="info-row">
                  <span class="label">Supports Editions:</span>
                  <span class="value">
                    {{ extension().editionsSupported ? 'Yes' : 'No' }}
                  </span>
                </div>
              </div>

              <div class="ext-features">
                <h4>Features used by this Extension</h4>
                <mat-chip-set>
                  @for (
                    feature of extension().features | keyvalue;
                    track feature.key
                  ) {
                    <mat-chip [class.disabled]="!feature.value">
                      {{ feature.key.split('Inside').join('') }}
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </div>
        </mat-expansion-panel>
      </mat-accordion>
    }
    
    <!-- Edition Selection -->
    @if (extension()?.editionsSupported && editions()?.length > 1) { <!-- Don't show if only default edition -->
      <div class="ext-editions">
        <h4>Editions to install this Extension to</h4>
        <div class="edition-selector">
          @for (edition of editions(); track edition.edition) {
            <mat-checkbox
              [checked]="selectedEditions().includes(edition.edition)"
              (change)="onEditionToggle(edition.edition, $event.checked)"
              color="accent"
            >
              {{ edition.edition || 'Default' }}
            </mat-checkbox>
          }
        </div>
      </div>
    }

    <!-- Force Install Option, only show if necessary -->
    @if (alreadyInstalled() && hasChanges()) {
      <div class="install-options" style="margin-top: 16px;">
        <h4>Caution: Import causes an Overwrite</h4>
        <p>
          Upgrading this extension will overwrite your changes.
          You must enable Force Install to proceed.
        </p>
        <mat-slide-toggle
          [(ngModel)]="forceInstall"
          color="primary">
          Force / Overwrite
        </mat-slide-toggle>
      </div>
    }
    
    @if (alreadyInstalled() && !hasChanges()) {
      <div class="install-options" style="margin-top: 16px;">
        <h4>Upgrade Available</h4>
        <p>
          This extension is already installed, but no local changes were detected.
          Force Install is <strong>not required</strong>.
        </p>
      </div>
    }

    <!-- Installing State / Spinner -->
    @if (isInstalling()) {
      <div class="installing">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Installing extension...</p>
      </div>
    }
  </div>

  <mat-dialog-actions align="end">
    <!-- Actions visible only when we have a valid preflight loaded -->
    @if (extension() && !isLoadingPreflight()) {
      <button
        mat-stroked-button
        (click)="cancelPreflight()"
        [disabled]="isInstalling()"
      >
        Cancel
      </button>
      
      <button
        mat-raised-button
        class="eav-action-button"
        (click)="install()"
        [disabled]="!canInstall()"
      >
        Install
      </button>
    }
  </mat-dialog-actions>
</div>