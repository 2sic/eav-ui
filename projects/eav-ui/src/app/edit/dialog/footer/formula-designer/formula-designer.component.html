<ng-container *ngIf="!loadError">
  <ng-container *ngIf="viewModel$ | async as vm">

    <div class="formula-context-box">
      <mat-form-field color="accent">
        <mat-label>Entity</mat-label>
        <mat-select [ngModel]="vm.designer.entityGuid"
          (ngModelChange)="selectedChanged(SelectTargets.Entity, $event)">
          <mat-option *ngFor="let entityOption of vm.entityOptions; trackBy: trackEntityOptions"
            [value]="entityOption.entityGuid">
            <span [ngClass]="{ 'has-formula': entityOption.hasFormula }">
              {{ entityOption.label }}
            </span>
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field color="accent">
        <mat-label>Attribute</mat-label>
        <mat-select [ngModel]="vm.designer.fieldName" (ngModelChange)="selectedChanged(SelectTargets.Field, $event)"
          [disabled]="vm.designer.entityGuid == null">
          <mat-option *ngFor="let fieldOption of vm.fieldOptions; trackBy: trackFieldOptions"
            [value]="fieldOption.fieldName">
            <span [ngClass]="{ 'has-formula': fieldOption.hasFormula }">
              {{ fieldOption.fieldName }}
            </span>
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field color="accent">
        <mat-label>Target</mat-label>
        <mat-select *ngIf="!freeTextTarget" [ngModel]="vm.designer.target"
          (ngModelChange)="selectedChanged(SelectTargets.Target, $event)"
          [disabled]="vm.designer.entityGuid == null || vm.designer.fieldName == null">
          <mat-option *ngFor="let targetOption of vm.targetOptions" [value]="targetOption.target">
            <span [ngClass]="{ 'has-formula': targetOption.hasFormula }">
              {{ targetOption.label }}
            </span>
          </mat-option>
        </mat-select>
        <input *ngIf="freeTextTarget" matInput [ngModel]="vm.designer.target"
          (ngModelChange)="selectedChanged(SelectTargets.Target, $event)"
          [disabled]="vm.designer.entityGuid == null || vm.designer.fieldName == null">
      </mat-form-field>

      <button mat-icon-button tippy="FreeText Target"
        [disabled]="vm.designer.entityGuid == null || vm.designer.fieldName == null" (click)="toggleFreeText()">
        <mat-icon>text_fields</mat-icon>
      </button>

      <div class="spacer"></div>

      <button mat-icon-button tippy="Help" (click)="openFormulasHelp()">
        <mat-icon>help</mat-icon>
      </button>
    </div>

    <div class="formula-box">
      <div class="formula-field" [ngClass]="{
        'disabled': !vm.designer.editMode || vm.designer.entityGuid == null || vm.designer.fieldName == null || vm.designer.target == null,
        'focused': focused
      }">
        <mat-label class="label">Function</mat-label>

        <app-monaco-editor class="editor" [filename]="filename" [value]="vm.formula?.source ?? placeholder"
          [jsTypings]="vm.typings" (valueChanged)="formulaChanged($event)" [options]="monacoOptions"
          (focused)="onFocused()" (blurred)="onBlurred()">
        </app-monaco-editor>
      </div>

      <div class="formula-snippets fancy-scrollbar-light" [ngClass]="{ 'disabled': !vm.designer.editMode }">
        <div class="snippet" *ngFor="let snippet of vm.dataSnippets; trackBy: trackSnippets" [title]="snippet.code"
          (click)="copyToClipboard(snippet.code)">
          {{ snippet.label | snippetLabelSize }}
        </div>
        <div class="separator" *ngIf="vm.dataSnippets?.length && vm.contextSnippets?.length"></div>
        <div class="snippet" *ngFor="let snippet of vm.contextSnippets; trackBy: trackSnippets" [title]="snippet.code"
          (click)="copyToClipboard(snippet.code)">
          {{ snippet.label | snippetLabelSize }}
        </div>
      </div>
    </div>

    <div class="formula-footer-box">
      <div class="formula-result-box hide-scrollbar">
        <span class="label">Result:&nbsp;</span>
        <ng-container *ngIf="vm.resultExists">
          <ng-container *ngIf="!vm.resultIsError">
            <span *ngIf="vm.result === undefined && !vm.resultIsOnlyPromise" class="result-undefined">undefined</span>
            <span *ngIf="vm.result === undefined && vm.resultIsOnlyPromise">promise(ü§ûüèΩ)</span>
            <span *ngIf="vm.result !== undefined">{{ vm.result | json }}</span>
          </ng-container>
          <span class="result-error" *ngIf="vm.resultIsError">
            Calculation failed. Please check logs for more info
          </span>
        </ng-container>
      </div>

      <div class="formula-actions-box">
        <button mat-icon-button tippy="Edit" (click)="toggleEdit()">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button tippy="Menu" [matMenuTriggerFor]="menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu" class="grid-more-menu">
          <button mat-menu-item (click)="deleteFormula()" [disabled]="!vm.formula?.sourceId">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
          <button mat-menu-item (click)="reset()">
            <mat-icon>history</mat-icon>
            <span>Reset</span>
          </button>
        </mat-menu>
        <button *ngIf="allowSaveFormula" mat-icon-button tippy="Save"
          [tippyDisabled]="!vm.designer.editMode || !vm.formula?.source"
          [disabled]="!vm.designer.editMode || !vm.formula?.source || vm.saving" (click)="save()">
          <mat-icon>save</mat-icon>
        </button>
        <button mat-icon-button class="run-button" tippy="Run"
          [disabled]="!vm.designer.editMode || !vm.formula?.source" (click)="run()">
          <mat-icon>play_arrow</mat-icon>
        </button>
      </div>
    </div>
  </ng-container>
</ng-container>