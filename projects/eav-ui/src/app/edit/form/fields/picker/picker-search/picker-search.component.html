<ng-container *ngIf="viewModel$ | async as vm">
  <div [hidden]="vm.hideDropdown">
    <mat-form-field [formGroup]="group" class="eav-form-field" color="accent"
      [ngClass]="{ 'mat-form-field-invalid': vm.controlStatus.invalid && vm.controlStatus.touched }">
      <input matInput #autocomplete [placeholder]="getPlaceholder(vm.availableItems, vm.error)"
        [matAutocomplete]="auto" [disabled]="vm.controlStatus.disabled || !vm.enableAddExisting"
        [value]="showSelectedItem ? vm.selectedItem?.Text : ''" (focus)="fetchEntities()"
        (blur)="markAsTouched()" (input)="filterSelectionList()"
        (click)="filterSelectionList()">
      <button mat-icon-button matSuffix class="entity-dropdown-button eav-suffix-button" disableRipple="true"
        [disabled]="vm.controlStatus.disabled || !vm.enableAddExisting">
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <button mat-icon-button matSuffix class="eav-suffix-button"
        *ngIf="vm.enableEdit && !vm.selectedItem?._disableEdit && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Edit' | translate" [disabled]="config.initialDisabled" appClickStopPropagation
        (click)="edit(vm.selectedItem?.Value, vm.selectedItem?.Id)">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button matSuffix class="eav-suffix-button"
        *ngIf="vm.enableDelete && !vm.selectedItem?._disableDelete && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Delete' | translate" [disabled]="vm.controlStatus.disabled" appClickStopPropagation
        (click)="deleteItem(0, vm.selectedItem?.Value)">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button matSuffix class="eav-suffix-button" *ngIf="vm.enableRemove && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Remove' | translate" [disabled]="vm.controlStatus.disabled" appClickStopPropagation
        (click)="removeItem(0)">
        <mat-icon>do_not_disturb_on</mat-icon>
      </button>
      <span *ngIf="vm.enableTextEntry" matSuffix class="eav-selection-suffix-inline">
        <ng-content select="[freeTextButtons]"></ng-content>
      </span>
      <mat-label [ngClass]="{ 'mat-error': vm.controlStatus.invalid && vm.controlStatus.touched }">
        {{ vm.label }} {{ vm.required ? '*': '' }}
      </mat-label>
    </mat-form-field>

    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn.bind(this)"
      (optionSelected)="optionSelected($event, vm.allowMultiValue, vm.selectedItem)"
      (closed)="onClosed(vm.selectedItems, vm.selectedItem)" (opened)="onOpened()">
      <div *ngIf="!vm.isTreeDisplayMode">
        <mat-option *ngFor="let item of vm.filteredItems" [value]="item.Value" class="eav-picker-option"
          [disabled]="item._disableSelect ? true : vm.enableReselect ? false : isOptionDisabled(item.Value, vm.selectedItems)" [tippy]="item.Tooltip"
          tippyShowDelay="500" [tippyDisabled]="!item.Tooltip">
          <div class="eav-dropdown-option">
            <span>{{ item.Text ? item.Text : item.Value }}</span>
            <mat-icon *ngIf="item.Information" [tippy]="item.Information">info</mat-icon>
          </div>
        </mat-option>
      </div>
      <!-- /** Needed later for tree implementation testing */ -->
      <!-- <mat-tree *ngIf="vm.isTreeDisplayMode" [dataSource]="dataSource" [treeControl]="treeControl">
        <mat-tree-node *matTreeNodeDef="let item;" matTreeNodePadding>
          <button mat-icon-button disabled></button>
          <mat-option [value]="item.Value" class="eav-picker-option"
            [disabled]="isOptionUnpickable(item, vm.selectedEntities, vm.enableReselect, vm.pickerTreeConfiguration)"
            [tippy]="item.Tooltip" tippyShowDelay="500" [tippyDisabled]="!item.Tooltip">
            <div class="eav-dropdown-option">
              <span>{{ item.Text ? item.Text : item.Value }}</span>
              <mat-icon *ngIf="item.Information" [tippy]="item.Information">info</mat-icon>
            </div>
          </mat-option>
        </mat-tree-node>
        <mat-tree-node *matTreeNodeDef="let item;when: hasChild" matTreeNodePadding>
          <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + item.name">
            <mat-icon class="mat-icon-rtl-mirror">
              {{treeControl.isExpanded(item) ? 'expand_more' : 'chevron_right'}}
            </mat-icon>
          </button>
          <mat-option [value]="item.Value" class="eav-picker-option"
            [disabled]="isOptionUnpickable(item, vm.selectedEntities, vm.enableReselect, vm.pickerTreeConfiguration)"
            [tippy]="item.Tooltip" tippyShowDelay="500" [tippyDisabled]="!item.Tooltip">
            <div class="eav-dropdown-option">
              <span>{{ item.Text ? item.Text : item.Value }}</span>
              <mat-icon *ngIf="item.Information" [tippy]="item.Information">info</mat-icon>
            </div>
          </mat-option>
        </mat-tree-node>
      </mat-tree> -->
    </mat-autocomplete>
    
  </div>
  <div *ngIf="vm.showEmpty">
    <mat-form-field class="eav-form-field" color="accent">
      <input matInput [placeholder]="'Fields.Entity.Empty' | translate" disabled>
    </mat-form-field>
  </div>

  <div *ngIf="vm.debugEnabled" class="null-box">
    debug: <span class="null-button" tippy="Add null-item" (click)="insertNull()">add null-item</span>
  </div>
</ng-container>