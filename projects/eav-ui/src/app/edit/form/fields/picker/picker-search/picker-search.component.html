<ng-container *ngIf="viewModel$ | async as vm">
  <div [hidden]="vm.hideDropdown">
    <mat-form-field [formGroup]="group" class="eav-form-field" color="accent" 
      [ngClass]="{ 'mat-form-field-invalid': vm.controlStatus.invalid && vm.controlStatus.touched }">
      <input id="autocomplete" matInput #autocomplete 
        [placeholder]="getPlaceholder(vm.availableEntities, vm.error)" 
        [matAutocomplete]="auto"
        [disabled]="vm.controlStatus.disabled || !vm.enableAddExisting" 
        [value]="showSelectedItem ? vm.selectedEntity?.label : ''"
        (focus)="fetchEntities(vm.availableEntities)" 
        (blur)="markAsTouched(vm.selectedEntity, vm.selectedEntities)"
        (input)="filterSelectionList()" 
        (click)="filterSelectionList()">
      <button mat-icon-button matSuffix class="entity-dropdown-button" disableRipple="true"
        [disabled]="vm.controlStatus.disabled || !vm.enableAddExisting" 
        *ngIf="!vm.enableTextEntry">
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <button mat-icon-button matSuffix
        *ngIf="vm.enableEdit && !vm.selectedEntity?.disableEdit && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Edit' | translate" 
        [disabled]="config.initialDisabled"
        appClickStopPropagation 
        (click)="edit(vm.selectedEntity?.value, vm.selectedEntity?.entityId)">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button matSuffix
        *ngIf="vm.enableDelete && !vm.selectedEntity?.disableDelete && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Delete' | translate" 
        [disabled]="vm.controlStatus.disabled"
        appClickStopPropagation 
        (click)="deleteItem(0, vm.selectedEntity?.value)">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-icon-button matSuffix 
        *ngIf="vm.enableRemove && vm.showItemEditButtons"
        [tippy]="'Fields.Entity.Remove' | translate" 
        [disabled]="vm.controlStatus.disabled" 
        appClickStopPropagation 
        (click)="removeItem(0)">
        <mat-icon>clear</mat-icon>
      </button>
      <span *ngIf="vm.enableTextEntry" matSuffix class="selection-suffix-inline">
        <ng-content select="[freeTextButtons]"></ng-content>
      </span>
      <mat-label [ngClass]="{ 'mat-error': vm.controlStatus.invalid && vm.controlStatus.touched }">
        {{ vm.label }} {{ vm.required ? '*': '' }}
      </mat-label>
    </mat-form-field>

    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="optionSelected($event, vm.allowMultiValue, vm.selectedEntity)">
      <mat-option *ngFor="let item of vm.filteredEntities" 
        [value]="item.Value"
        [disabled]="isOptionDisabled(item.Value, vm.selectedEntities)" 
        [tippy]="vm.tooltip" 
        tippyShowDelay="500" 
        [tippyDisabled]="vm.tooltip === ''">
        <div class="dropdown-option">
          <span>{{ item.Text ? item.Text : item.Value }}</span>
          <mat-icon *ngIf="vm.information !== ''" [tippy]="vm.information">info</mat-icon>
        </div>
      </mat-option>
    </mat-autocomplete>
  </div>
  <div *ngIf="vm.showEmpty">
    <mat-form-field class="eav-form-field" color="accent">
      <input matInput [placeholder]="'Fields.Entity.Empty' | translate" disabled>
    </mat-form-field>
  </div>

  <div *ngIf="vm.debugEnabled" class="null-box">
    debug: <span class="null-button" tippy="Add null-item" (click)="insertNull()">add null-item</span>
  </div>
</ng-container>